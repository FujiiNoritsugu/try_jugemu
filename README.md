# try-jugemu

偶発的なコードを生成し、遺伝的アルゴリズムで進化させるPythonプログラム

## 概要

このプロジェクトは、ランダムなPythonコードを生成し、遺伝的アルゴリズムを用いてより優れたコードへと進化させるプログラムです。生成されたコードは自動的に実行され、エラーが発生した場合は自動修正を試みます。

## 機能

### 1. コード生成機能

- **ランダム識別子生成**: 変数名や関数名をランダムに生成
- **ランダム値生成**: int, str, bool, listの値をランダムに生成
- **ランダム関数生成**: パラメータ、処理内容、戻り値を持つ関数を生成
- **ランダムクラス生成**: 複数のメソッドを持つクラスを生成

### 2. 自動実行・修正機能

生成されたコードを実行し、エラーが発生した場合は自動的に修正を試みます（最大3回）。

**対応エラー:**
- **ゼロ除算エラー**: `// 0` や `% 0` を `// 1` や `% 1` に置き換え
- **構文エラー**: 空のブロックに適切なインデントで`pass`を追加
- **その他のエラー**: 新しいコードを生成して再試行

### 3. 遺伝的アルゴリズム

コードを個体として扱い、世代を重ねることでより優れたコードに進化させます。

#### 3.1 個体と適応度評価

**Individual クラス**:
- `code`: プログラムコード
- `fitness`: 適応度スコア

**適応度評価基準**:
- 実行成功: 100点
- 実行時間が短い: 最大20点
- コードの複雑さ（関数・クラスの数）: 関数5点/個、クラス10点/個
- 適度なコード長（20〜50行）: 10点
- エラーの種類による部分点:
  - ゼロ除算: 30点（修正可能）
  - その他のエラー: 20点
  - 構文エラー: 10点

#### 3.2 遺伝的操作

**選択（Selection）**:
- トーナメント選択方式
- 3個体からランダムに選び、最も適応度の高い個体を親として選択

**交叉（Crossover）**:
- 2つの親から関数とクラスを抽出
- ランダムに組み合わせて子を生成
- 関数: 最大3個、クラス: 最大2個を選択

**突然変異（Mutation）**:
- 確率: 20%
- 変異タイプ:
  - 新しい関数を追加
  - 新しいクラスを追加
  - 既存の関数を置き換え

**エリート保存**:
- 各世代の上位2個体を次世代に無条件で残す

#### 3.3 進化プロセス

1. 初期個体群を生成（デフォルト10個体）
2. 各個体の適応度を評価
3. 適応度でソートし、統計情報を表示
4. 次世代を生成:
   - 上位2個体をエリート保存
   - 残りはトーナメント選択→交叉→突然変異で生成
5. 指定世代数（デフォルト5世代）繰り返し
6. 最良個体のコードを実行

## 使い方

### インストール

```bash
cd try-jugemu
```

### 実行

```bash
python main.py
```

実行すると、モード選択が表示されます:

```
モードを選択してください (1: 通常, 2: 遺伝的アルゴリズム, 3: LLM改善, 4: 遺伝的アルゴリズム+LLM, 5: シミュレーテッドアニーリング, 6: シミュレーテッドアニーリング+LLM):
```

#### モード1: 通常モード

偶発的なコードを1つ生成し、実行します。エラーが発生した場合は自動修正を試みます。

```bash
1
```

#### モード2: 遺伝的アルゴリズムモード

10個体×5世代で進化させ、最良個体を実行します。

```bash
2
```

#### モード3: LLM改善モード

偶発的なコードを1つ生成し、LLMで意味のあるコードに改善してから実行します。

```bash
3
```

#### モード4: 遺伝的アルゴリズム+LLMモード

遺伝的アルゴリズムで進化させた後、LLMで改善して実行します。

```bash
4
```

#### モード5: シミュレーテッドアニーリングモード

温度パラメータを使った最適化手法で、徐々に温度を下げながらコードを最適化します。

```bash
5
```

#### モード6: シミュレーテッドアニーリング+LLMモード

シミュレーテッドアニーリングで最適化した後、LLMで改善して実行します。

```bash
6
```

**出力例**:
```
============================================================
遺伝的アルゴリズムを開始します
個体数: 10, 世代数: 5
============================================================

【第1世代】
最高適応度: 145.00
平均適応度: 123.50
最良個体のコード（最初の5行）:
# 偶発的に生成されたコード

def x9a2b(p3c, q5d):
    """偶発的に生成された関数"""
    print(42)
...
```

### 4. シミュレーテッドアニーリング

温度パラメータを用いた最適化手法で、コードを徐々に改善します。

#### 4.1 アルゴリズムの概要

シミュレーテッドアニーリング（焼きなまし法）は、物理学の焼きなまし過程にヒントを得た最適化アルゴリズムです。高温時は悪い解も受け入れることで局所最適解から脱出し、温度を下げながら徐々に良い解に収束させます。

#### 4.2 最適化プロセス

1. **初期化**
   - 初期解（ランダムコード）を生成
   - 初期温度を設定（デフォルト: 100.0）

2. **反復最適化**
   - 現在の解を突然変異させて新しい解を生成
   - 新しい解の適応度を評価
   - メトロポリス基準で受理判定:
     - 適応度が向上: 必ず受理
     - 適応度が低下: 確率 `exp(Δ/T)` で受理（Δ: 適応度差、T: 温度）
   - 最良解を更新
   - 温度を下げる（デフォルト冷却率: 0.95）

3. **終了条件**
   - 温度が最低温度（デフォルト: 0.1）に達したら終了

#### 4.3 パラメータ

- **初期温度**: 100.0（高いほど初期段階で悪い解も受け入れやすい）
- **冷却率**: 0.95（各反復で温度に乗じる値、小さいほど急速に冷却）
- **最低温度**: 0.1（これ以下になったら終了）
- **突然変異率**: 0.3（遺伝的アルゴリズムより高めに設定）

#### 4.4 メトロポリス基準

適応度が `Δ` だけ悪化する場合、以下の確率で受理:

```
P(accept) = exp(Δ / T)
```

- 温度 `T` が高い: 悪化も受け入れやすい（探索的）
- 温度 `T` が低い: 良い解のみ受け入れる（収束的）

#### 4.5 遺伝的アルゴリズムとの比較

| 項目 | 遺伝的アルゴリズム | シミュレーテッドアニーリング |
|------|-------------------|----------------------------|
| 個体数 | 複数（10個体） | 単一 |
| 探索方法 | 交叉・突然変異 | 突然変異のみ |
| 局所最適解からの脱出 | 多様性で対応 | 確率的受理で対応 |
| 計算コスト | 高い | 低い |
| 収束速度 | 遅い | 速い |

**出力例**:
```
============================================================
シミュレーテッドアニーリングを開始します
初期温度: 100.0, 冷却率: 0.95, 最低温度: 0.1
============================================================

初期解の適応度: 125.00
初期コード（最初の5行）:
# 偶発的に生成されたコード

def x9a2b(p3c, q5d):
    """偶発的に生成された関数"""

[反復 1] 🌟 最良解更新! 適応度: 135.00, 温度: 100.00
[反復 10] 温度: 59.87, 現在: 140.00, 最良: 145.00, 状態: 改善
[反復 20] 温度: 35.85, 現在: 135.00, 最良: 145.00, 状態: 確率的受理 (p=0.1889)
...

============================================================
最適化完了！総反復回数: 67
最良解の適応度: 165.00
============================================================
```

## コード構成

### 主要関数

- `generate_random_identifier(length)`: ランダムな識別子を生成
- `generate_random_value()`: ランダムな値を生成
- `generate_random_operation()`: ランダムな操作を生成
- `generate_random_function()`: ランダムな関数を生成
- `generate_random_class()`: ランダムなクラスを生成
- `generate_code(num_functions, num_classes)`: 完全なコードを生成

### エラー修正関数

- `fix_division_by_zero(code)`: ゼロ除算を修正
- `fix_syntax_error(code)`: 構文エラーを修正
- `execute_generated_code(code, max_retries)`: コード実行とエラー修正

### 遺伝的アルゴリズム関数

- `Individual`: 個体クラス
  - `evaluate_fitness()`: 適応度評価
  - `extract_functions()`: 関数抽出
  - `extract_classes()`: クラス抽出
- `selection(population, tournament_size)`: トーナメント選択
- `crossover(parent1, parent2)`: 交叉操作
- `mutate(individual, mutation_rate)`: 突然変異
- `genetic_algorithm(population_size, generations)`: メインループ

### シミュレーテッドアニーリング関数

- `simulated_annealing(initial_temp, cooling_rate, min_temp, use_llm)`: シミュレーテッドアニーリングのメインループ
  - 初期解の生成と評価
  - 温度管理と冷却
  - メトロポリス基準による受理判定
  - 最良解の追跡

### LLM関連関数

- `improve_code_with_llm(code)`: LLMを使ってコードを改善
- `evaluate_code_with_llm(original_code, improved_code)`: LLMを使ってコードを評価

## カスタマイズ

### パラメータ調整

`main.py`の以下の値を変更することでカスタマイズできます:

```python
# 遺伝的アルゴリズムのパラメータ
genetic_algorithm(
    population_size=10,  # 個体数
    generations=5        # 世代数
)

# シミュレーテッドアニーリングのパラメータ
simulated_annealing(
    initial_temp=100.0,   # 初期温度（高いほど探索的）
    cooling_rate=0.95,    # 冷却率（小さいほど急速に収束）
    min_temp=0.1          # 最低温度（終了条件）
)

# 突然変異率
mutate(individual, mutation_rate=0.2)  # 20%（GAの場合）
mutate(individual, mutation_rate=0.3)  # 30%（SAの場合）

# トーナメントサイズ
selection(population, tournament_size=3)  # 3個体

# 初期コード生成
generate_code(
    num_functions=3,  # 関数の数
    num_classes=2     # クラスの数
)
```

## 技術仕様

- **言語**: Python 3.12+
- **依存ライブラリ**:
  - 標準ライブラリ: random, string, time, re, math, os
  - 外部ライブラリ: anthropic, python-dotenv（LLM機能使用時）
- **プロジェクト管理**: pyproject.toml

## ライセンス

このプロジェクトは実験的なコード生成プログラムです。生成されたコードの実行は自己責任で行ってください。

## 今後の拡張案

- より高度な適応度関数（出力の多様性、特定のパターンの検出など）
- 複数の親から交叉する多点交叉
- コードの意味的な解析による突然変異
- 進化の過程を可視化する機能（適応度の推移グラフなど）
- 生成されたコードのデータベース保存
- 特定の目標（例: 特定の出力を生成する）に向けた進化
- 他の最適化アルゴリズムの追加:
  - 粒子群最適化（PSO）
  - 差分進化（DE）
  - ベイズ最適化
  - 強化学習ベースのコード生成
- ハイブリッド手法（遺伝的アルゴリズム + シミュレーテッドアニーリング）
